Release SirrOS (rootfs + installer)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: commander-Z3R0/Sirr-OS
          path: Sirr-OS

      - name: Install dependencies (Docker, bmap-tools, qemu-user-static)
        run: |
          sudo apt-get update
          sudo apt-get install -y bmap-tools qemu-user-static
          if ! command -v docker &> /dev/null; then
            echo "Docker is not installed, installing..."
            curl -fsSL https://get.docker.com | sudo sh
          else
            echo "Docker is already installed, skipping installation."
          fi

      - name: Generate tag
        id: tag
        run: echo "tag_name=SirrOS-Installer-$(date +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Build SirrOS rootfs
        run: |
          cd Sirr-OS

          device="pinephonepro"
          environment="phosh"
          arch="arm64"
          rootfs_file="rootfs-${arch}.sqfs"

          # Clean previous files
          rm -f "$rootfs_file"

          echo "Building ROOTFS (SirrOS real)..."

          docker run --rm \
            --device /dev/kvm \
            -v "$PWD":/work \
            -w /work \
            --security-opt label=disable \
            godebos/debos \
            -t architecture:"${arch}" \
            -t device:"${device}" \
            -t environment:"${environment}" \
            -t nonfree:true \
            rootfs.yaml

          if [ ! -f "$rootfs_file" ]; then
            echo "âŒ ERROR: rootfs not built!"
            exit 1
          fi

      - name: Build SirrOS installfs
        run: |
          cd Sirr-OS

          device="pinephonepro"
          environment="phosh"
          arch="arm64"
          installfs_file="installfs-${arch}.tar.gz"

          rm -f "${installfs_file}"

          echo "Building INSTALLFS (Live Installer)..."

          docker run --rm \
            --device /dev/kvm \
            -v "$PWD":/work \
            -w /work \
            --security-opt label=disable \
            godebos/debos \
            -t architecture:"${arch}" \
            -t device:"${device}" \
            -t environment:"${environment}" \
            -t installfs:"${installfs_file}" \
            -t nonfree:true \
            --scratchsize=8G \
            installfs.yaml

          if [ ! -f "$installfs_file" ]; then
            echo "âŒ ERROR: installfs not built!"
            exit 1
          fi

      - name: Build final SirrOS Installer image
        run: |
          cd Sirr-OS
          device="pinephonepro"
          environment="phosh"
          arch="arm64"
          image_file="SirrOS-Installer-${device}-${environment}"

          rm -f "${image_file}.img"

          echo "Creating final installer IMG..."

          docker run --rm \
            --device /dev/kvm \
            -v "$PWD":/work \
            -w /work \
            --security-opt label=disable \
            godebos/debos \
            -t architecture:"${arch}" \
            -t device:"${device}" \
            -t environment:"${environment}" \
            -t installfs:"installfs-${arch}.tar.gz" \
            -t image:"${image_file}" \
            -t nonfree:true \
            -t partitiontable:gpt \
            -t filesystem:ext4 \
            --scratchsize=10G \
            installer.yaml

          if [ -f "${image_file}.img" ]; then
            bmaptool create "${image_file}.img" > "${image_file}.img.bmap"
          else
            echo "âŒ ERROR: installer image not generated!"
            exit 1
          fi

      - name: Upload installer to GoFile
        env:
          GOFILE_TOKEN: ${{ secrets.GOFILE_TOKEN }}
          GOFILE_FOLDER_ID: ${{ secrets.GOFILE_FOLDER_ID }}
        run: |
          cd Sirr-OS
          device="pinephonepro"
          environment="phosh"
          image_file="SirrOS-Installer-${device}-${environment}"
          FILE_PATH="${image_file}.img"

          if [ ! -f "$FILE_PATH" ]; then
            echo "âŒ File not found: $FILE_PATH"
            exit 1
          fi

          echo "ðŸ“¡ Getting server from GoFile..."
          SERVER_JSON=$(curl -s "https://api.gofile.io/servers")
          SERVER=$(echo "$SERVER_JSON" | jq -r '.data.servers[0].name')

          if [ -z "$SERVER" ] || [ "$SERVER" == "null" ]; then
            echo "âŒ Error getting server: $SERVER_JSON"
            exit 1
          fi

          echo "ðŸ–¥ï¸ Server: $SERVER"
          echo "ðŸ“¤ Uploading..."

          RESPONSE=$(curl -s -X POST "https://${SERVER}.gofile.io/uploadFile" \
            -H "Authorization: Bearer $GOFILE_TOKEN" \
            -F "file=@$FILE_PATH" \
            -F "folderId=$GOFILE_FOLDER_ID")

          echo "ðŸ“¦ Response:"
          echo "$RESPONSE"

          LINK=$(echo "$RESPONSE" | jq -r '.data.downloadPage')
          if [ -z "$LINK" ] || [ "$LINK" == "null" ]; then
            echo "âŒ Upload failed"
            exit 1
          fi

          echo "âœ… Upload complete!"
          echo "ðŸ”— Link: $LINK"
          echo "link=$LINK" >> $GITHUB_OUTPUT
